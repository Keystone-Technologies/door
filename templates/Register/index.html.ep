<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <title>Register</title>
    <script>
        
        var badgeHtml = "";
        
        function signIn() {
            $.ajax({
                url: '<%= url_for('signin') %>',
                type: "POST",
                dataType: "json",
                data: {name : $("#name").val(),
                       pin : $("#pin").val()
                }
            }).done(function(data){
                if(data.results) {
                    $("#signIn").hide();
                    $("#addUser").show();
                    $("#badgeRegistration").show();
                }
                else
                {
                    $("#error").html("Invalid login").show();
                    setTimeout(function(){$("#error").hide()}, 5000);
                }
            });
        }
        
        function addUser() {
            $.ajax({
                url: '<%= url_for('adduser') %>',
                type: "POST",
                dataType: "json",
                data: {name : $("#name").val(),
                       pin : $("#pin").val(),
                       newName : $("#newName").val(),
                       newPin : $("#newPin").val(),
                       auth : ($("#allTimes").is(":checked") ? 1 : 2)
                       
                }
            }).done(function(data){
                if(data.results) {
                    $("#newError").html("Succes! New user added.").show();
                    setTimeout(function(){$("#newError").hide()}, 5000);
                    $("#newName").val('');
                    $("#newPin").val('');
                }
                else
                {
                    $("#newError").html("Failed for unkown reason.").show();
                    setTimeout(function(){$("#newError").hide()}, 5000);
                }
            });
        }
        
        function showBadges() {
            $("#badgeTableContainer").show();
            var start = $("#startRange").val();
            var end = $("#endRange").val();
            if(badgeHtml == ""){badgeHtml = $("#badgeTableContainer").html()};
            var html = "";
            for(var i = 0; i <= end - start; i ++) {
                var num = (parseInt(start) + parseInt(i)).toString();
                html += badgeHtml.replace(/ID/g, num);
            }
            $("#badgeTableContainer").html(html);
            
            $(".nameBox").on('keydown', function(event){
                if(event.which == 9 || event.keycode == 9) {
                    submitName(parseInt($(this).attr('id').substring($(this).attr('id').indexOf('_') + 1)), $(this).val());
                }
            });
            
            $.ajax({
                url: '<%= url_for('badges') %>',
                type: "GET",
                dataType: "json",
                data: {name : $("#name").val(),
                       pin : $("#pin").val(),
                       start : start,
                       end : end
                }
            }).done(function(data){
                if(!$("#showUsedBadges").is(":checked")) {
                    data.forEach(function(item, index){
                        $("#badgeContainer_" + item.badge_id).hide();
                    });
                }
                else {
                    data.forEach(function(item, index) {
                       $("#nameBox_" + item.badge_id).val(item.name);
                       if(item.authorized == 1) {
                           $("#allTimes_" + item.badge_id).prop('checked', true);
                       }
                    });
                }
            });
        }
        
        function submitName(badgeId, name) {
            $.ajax({
                url: '<%= url_for('addbadge') %>',
                type: "POST",
                dataType: "json",
                data: {name : $("#name").val(),
                       pin : $("#pin").val(),
                       badge : badgeId,
                       newName : name,
                       auth : ($("#allTimes_" + badgeId).is(":checked") ? 1 : 2)
                }
            }).done(function(data){
                if(data.results) {
                    console.log("Success!");
                }
                else {
                    console.log("No success!");
                }
            });
        }
        
        $(document).ready(function(){
            $("#addUser").hide();
            $("#error").hide();
            $("#badgeRegistration").hide();
            $("#badgeTableContainer").hide();
        });
        
    </script>
</head>
<body>
    <h3><a href='/'>Return Home</a></h3>
    <div id="signIn">
        <h1>sign in</h1>
        <h3>To register a new user, you must be signed in and authorized</h3>
        <input id="name" type="text" placeholder="name"></textarea>
        <input id="pin" type="password" rows=1 placeholder="pin">
        <button onclick="signIn()">sign in</button>
        <span id="error" style="color:red"></span>
    </div>
    <div id="addUser">
        <h1>add user</h1>
        <h3>Check the box to allow the user to use the door at all times and allow the user to add more users</h3>
        <input id="newName" type="text" placeholder="name"></textarea>
        <input id="newPin" type="password" rows=1 placeholder="pin">
        <input id="allTimes" type="checkbox">
        <button onclick="addUser()">Add User</button>
        <span id="newError" style="color:red"></span>
    </div>
    <div id="badgeRegistration">
        <h1>Register Badges</h1>
        <h3>Enter the range of badge id's you wish to register</h3>
        start : <input id="startRange" type="number">
        end : <input id="endRange" type="number">
        <button onclick="showBadges()">show badges</button>
        <span>Show used badges:</span><input style="margin-bottom: 40px" id="showUsedBadges" type="checkbox">
        <h3>Enter a name, press tab to submit and move to next box<br>Check the box to allow the user to access the door at all times</h3>
        <div id="badgeTableContainer">
            <div id="badgeContainer_ID">
                <div style="width: 80px; display: inline-block;">ID</div>
                <input class="nameBox" id="nameBox_ID" type="text" placeholder="name">
                <input id="allTimes_ID" type="checkbox">
            </div>
        </div>
    </div>
</body>

</html>